@model IEnumerable<HVAC.Models.ServiceRequest>

@{
    ViewBag.Title = "List";
    ViewBag.pTitle = "Service Request";
    ViewBag.pageTitle = "HVAC";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Html.AntiForgeryToken()

<script type="text/javascript">
    $(document).ready(function () {
        $('#serviceRequest-table tfoot th').each(function () {
            var title = $(this).text();
            $(this).html('<input type="text" style="width:100%" />');
        });

        var table = $('#serviceRequest-table').DataTable({
            "order": [[0, "desc"]],
            "pageLength": 25,
            "responsive": true,
            "columnDefs": [
                { "orderable": false, "targets": -1 } // Disable sorting on Action column
            ]
        });

        table.columns().every(function () {
            var that = this;

            $('input', this.footer()).on('keyup change', function () {
                if (that.search() !== this.value) {
                    that
                        .search(this.value)
                        .draw();
                }
            });
        });
    });

    function Delete(id) {
        Swal.fire({
            title: "Are you sure?",
            text: "Do you want to delete this Service Request?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#34c38f",
            cancelButtonColor: "#f46a6a",
            confirmButtonText: "Yes, delete it!"
        }).then(function (result) {
            if (result.value) {
                $.ajax({
                    type: "POST",
                    url: '/ServiceRequest/Delete',
                    data: { 
                        id: id,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.status == "OK") {
                            Swal.fire("Deleted!", response.message, "success");
                            window.location.reload();
                        } else {
                            Swal.fire("Error!", response.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Error!", "An error occurred while deleting the service request.", "error");
                    }
                });
            }
        });
    }
</script>

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h4 class="card-title mb-4">Service Requests</h4>
            </div>
            <div class="col-md-6 text-md-end">
                <a class="btn btn-primary waves-effect waves-light" href="/ServiceRequest/Create">
                    <i class="mdi mdi-plus me-1"></i> New Service Request
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table project-list-table align-middle table-nowrap dt-responsive nowrap w-100 table-borderless dataTable no-footer dtr-inline" id="serviceRequest-table" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Service Request No.</th>
                        <th>Customer</th>
                        <th>Equipment</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Creation Date</th>
                        <th>Scheduled Date</th>
                        <th>Assigned To</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>ID</th>
                        <th>Service Request No.</th>
                        <th>Customer</th>
                        <th>Equipment</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Creation Date</th>
                        <th>Scheduled Date</th>
                        <th>Assigned To</th>
                        <th>Action</th>
                    </tr>
                </tfoot>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                <span class="fw-bold text-primary">@item.ServiceRequestID</span>
                            </td>
                            <td>
                                <span class="fw-bold text-dark">@item.ServiceRequestNo</span>
                            </td>
                            <td>
                                <div>
                                    <h6 class="mb-0 text-dark">@item.CustomerMaster?.CustomerName</h6>
                                    @if (!string.IsNullOrEmpty(item.ContactPerson))
                                    {
                                        <small class="text-muted">@item.ContactPerson</small>
                                    }
                                </div>
                            </td>
                            <td>
                                <div>
                                    <h6 class="mb-0 text-dark">@item.Equipment?.EquipmentName</h6>
                                    @if (!string.IsNullOrEmpty(item.Equipment?.Brand) && !string.IsNullOrEmpty(item.Equipment?.Model))
                                    {
                                        <small class="text-muted">@item.Equipment.Brand - @item.Equipment.Model</small>
                                    }
                                </div>
                            </td>
                            <td>
                                @{
                                    string priorityClass = "";
                                    string priorityText = item.Priority?.PriorityName ?? "N/A";
                                    switch (priorityText)
                                    {
                                        case "High":
                                            priorityClass = "bg-danger";
                                            break;
                                        case "Medium":
                                            priorityClass = "bg-warning";
                                            break;
                                        case "Low":
                                            priorityClass = "bg-success";
                                            break;
                                        default:
                                            priorityClass = "bg-secondary";
                                            break;
                                    }
                                }
                                <span class="badge @priorityClass">@priorityText</span>
                            </td>
                            <td>
                                @{
                                    string statusClass = "";
                                    string statusText = item.ServiceStatus?.ServiceStatusName ?? "N/A";
                                    switch (statusText)
                                    {
                                        case "Pending":
                                            statusClass = "bg-warning";
                                            break;
                                        case "Work In Progress":
                                            statusClass = "bg-primary";
                                            break;
                                        case "Waiting for parts":
                                            statusClass = "bg-info";
                                            break;
                                        case "Closed":
                                            statusClass = "bg-success";
                                            break;
                                        default:
                                            statusClass = "bg-secondary";
                                            break;
                                    }
                                }
                                <span class="badge @statusClass">@statusText</span>
                            </td>
                            <td>
                                <span class="text-muted">@item.CreationDate.ToString("dd/MM/yyyy")</span>
                            </td>
                            <td>
                                @if (item.ScheduledDate.HasValue)
                                {
                                    <span class="text-dark">@item.ScheduledDate.Value.ToString("dd/MM/yyyy")</span>
                                }
                                else
                                {
                                    <span class="text-muted">Not Scheduled</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.AssignedTo))
                                {
                                    <span class="text-dark">@item.AssignedTo</span>
                                }
                                else
                                {
                                    <span class="text-muted">Unassigned</span>
                                }
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <a href="@Url.Action("Details", new { id = item.ServiceRequestID })" class="text-primary" title="View Details">
                                        <i class="mdi mdi-eye font-size-18"></i>
                                    </a>
                                    <a href="@Url.Action("Edit", new { id = item.ServiceRequestID })" class="text-success" title="Edit">
                                        <i class="mdi mdi-pencil font-size-18"></i>
                                    </a>
                                    <a href="#" onclick="Delete(@item.ServiceRequestID)" class="text-danger" title="Delete">
                                        <i class="mdi mdi-delete font-size-18"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (TempData["SuccessMsg"] != null)
{
    <script type="text/javascript">
        $(document).ready(function () {
            $.notify("@TempData["SuccessMsg"]", "success");
        });
    </script>
}

@if (TempData["ErrorMsg"] != null)
{
    <script type="text/javascript">
        $(document).ready(function () {
            $.notify("@TempData["ErrorMsg"]", "error");
        });
    </script>
}
