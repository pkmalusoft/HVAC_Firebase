@model HVAC.Models.JobDetailsViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    //var isPdf = (Request?.Browser?.Browser ?? "").Equals("wkhtmltopdf", System.StringComparison.OrdinalIgnoreCase);
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Job Details - @Model.Job.JobNo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- If you use Skote/Bootstrap globally, include them in _Layout. Minimal fallback here -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body { font-size: 12px; }
        .card { border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,.05); margin-bottom: 14px; }
        .card-header { background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .muted { color: #6c757d; }
        .badge-status { font-size: 11px; }
        .kv { font-weight: 600; }
        .table thead th { background: #f1f3f5; font-weight: 600; }
        .table tfoot td { background: #f8f9fa; font-weight: 600; }
        .page-break { page-break-before: always; }
        /* Hide buttons/links in PDF */
        @@media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-light">

    <div class="container-fluid p-3 p-md-4">
        <div class="d-flex justify-content-between align-items-center mb-3 no-print">
            <h4 class="m-0">Job Details</h4>
            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" href="@Url.Action("Details", "Jobs", new { id = Model.Job.JobNo })">
                    View
                </a>
                <a class="btn btn-primary" href="@Url.Action("DetailsPdf", "Jobs", new { id = Model.Job.JobNo })">
                    Download PDF
                </a>
            </div>
        </div>

        <!-- Header -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">@Model.Job.Title</h5>
                        <small class="text-muted">Job No: @Model.Job.JobNo</small>
                    </div>
                    <span class="badge bg-info badge-status">@Model.Job.Status</span>
                </div>
            </div>
            <div class="card-body row g-3">
                <div class="col-md-3"><div class="kv muted">Project Site</div><div>@Model.Job.ProjectSite</div></div>
                <div class="col-md-3"><div class="kv muted">Start Date</div><div>@Model.Job.StartDate:dd-MMM-yyyy</div></div>
                
                <div class="col-md-3">
                    <div class="kv muted">End Date</div>
                    <div>
                        @(Model.Job.EndDate.HasValue
            ? Model.Job.EndDate.Value.ToString("dd-MMM-yyyy")
            : "-")
                    </div>
                </div>
                <div class="col-md-3"><div class="kv muted">Project Manager</div><div>@Model.Job.ProjectManager</div></div>
                @if (!string.IsNullOrWhiteSpace(Model.Job.Notes))
                {
                    <div class="col-12"><div class="kv muted">Notes</div><div>@Model.Job.Notes</div></div>
                }
            </div>
        </div>

        <!-- Customer Details -->
        <div class="card">
            <div class="card-header"><h6 class="mb-0">Customer Details</h6></div>
            <div class="card-body row g-3">
                <div class="col-md-3"><div class="kv muted">Customer</div><div>@Model.Customer.Name (@Model.Customer.Code)</div></div>
                <div class="col-md-3"><div class="kv muted">Contact</div><div>@Model.Customer.ContactPerson</div></div>
                <div class="col-md-3"><div class="kv muted">Phone</div><div>@Model.Customer.Phone</div></div>
                <div class="col-md-3"><div class="kv muted">Email</div><div>@Model.Customer.Email</div></div>
                <div class="col-md-6"><div class="kv muted">Billing Address</div><div>@Model.Customer.BillingAddress</div></div>
                <div class="col-md-6"><div class="kv muted">Shipping Address</div><div>@Model.Customer.ShippingAddress</div></div>
                <div class="col-md-3"><div class="kv muted">TRN / VAT</div><div>@Model.Customer.TRN_VAT</div></div>
            </div>
        </div>

        <!-- PO List -->
        <div class="card">
            <div class="card-header"><h6 class="mb-0">Purchase Orders</h6></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead>
                            <tr>
                                <th style="width: 16%">PO No</th>
                                <th style="width: 12%">PO Date</th>
                                <th>Vendor</th>
                                <th style="width: 8%">Curr</th>
                                <th style="width: 14%" class="text-end">Amount</th>
                                <th style="width: 16%">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.PurchaseOrders != null && Model.PurchaseOrders.Count > 0)
                            {
                                foreach (var po in Model.PurchaseOrders)
                                {
                                    <tr>
                                        <td>@po.PONo</td>
                                        <td>@po.PODate:dd-MMM-yyyy</td>
                                        <td>@po.Vendor</td>
                                        <td>@po.Currency</td>
                                        <td class="text-end">@po.Amount.ToString("N3")</td>
                                        <td>@po.Status</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="6" class="text-center text-muted">No POs available.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bonds -->
        <div class="card">
            <div class="card-header"><h6 class="mb-0">Bond Details</h6></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead>
                            <tr>
                                <th style="width:14%">Type</th>
                                <th style="width:14%">Bond No</th>
                                <th style="width:12%">Valid From</th>
                                <th style="width:12%">Valid To</th>
                                <th style="width:14%" class="text-end">Amount</th>
                                <th style="width:16%">Issuer</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Bonds!=null & Model.Bonds.Count > 0)
                            {
                                foreach (var b in Model.Bonds)
                                {
                                    <tr>
                                        <td>@b.BondType</td>
                                        <td>@b.BondNo</td>
                                        <td>@b.ValidFrom:dd-MMM-yyyy</td>
                                        <td>@b.ValidTo:dd-MMM-yyyy</td>
                                        <td class="text-end">@b.Amount.ToString("N3")</td>
                                        <td>@b.Issuer</td>
                                        <td>@b.Remarks</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="7" class="text-center text-muted">No bonds available.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Warranty & Payment Terms -->
        <div class="row">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header"><h6 class="mb-0">Warranty Terms</h6></div>
                    <div class="card-body">
                        @if (Model.WarrantyTerms!=null && Model.WarrantyTerms.Count> 0)
                        {
                            <ol class="mb-0">
                                @foreach (var t in Model.WarrantyTerms)
                                {
                                    <li class="mb-1">@t</li>
                                }
                            </ol>
                        }
                        else
                        {
                            <div class="text-muted">No warranty terms defined.</div>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header"><h6 class="mb-0">Payment Terms</h6></div>
                    <div class="card-body">
                        @if (Model.PaymentTerms!=null &&  Model.PaymentTerms.Count > 0)
                        {
                            <ol class="mb-0">
                                @foreach (var t in Model.PaymentTerms)
                                {
                                    <li class="mb-1">@t</li>
                                }
                            </ol>
                        }
                        else
                        {
                            <div class="text-muted">No payment terms defined.</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Costing -->
        <div class="card page-break">
            <div class="card-header"><h6 class="mb-0">Costing Summary</h6></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle mb-3">
                        <thead>
                            <tr>
                                <th>Head</th>
                                <th class="text-end" style="width:20%">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Materials</td><td class="text-end">@Model.Costing.Materials.ToString("N3")</td></tr>
                            <tr><td>Labor</td><td class="text-end">@Model.Costing.Labor.ToString("N3")</td></tr>
                            <tr><td>Subcontract</td><td class="text-end">@Model.Costing.Subcontract.ToString("N3")</td></tr>
                            <tr><td>Overheads</td><td class="text-end">@Model.Costing.Overheads.ToString("N3")</td></tr>
                            <tr><td>Contingency</td><td class="text-end">@Model.Costing.Contingency.ToString("N3")</td></tr>
                            <tr><td>Taxes</td><td class="text-end">@Model.Costing.Taxes.ToString("N3")</td></tr>
                            <tr><td>Discount</td><td class="text-end">(@Model.Costing.Discount.ToString("N3"))</td></tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td>Total Cost</td>
                                <td class="text-end">@Model.Costing.TotalCost.ToString("N3")</td>
                            </tr>
                            <tr>
                                <td>Quoted Price</td>
                                <td class="text-end">@Model.Costing.QuotedPrice.ToString("N3")</td>
                            </tr>
                            <tr>
                                <td>Margin</td>
                                <td class="text-end">
                                    @Model.Costing.Margin.ToString("N3")
                                    <span class="text-muted">(@Model.Costing.MarginPct.ToString("0.00")%)</span>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="small text-muted">
                    <strong>Notes:</strong> Taxes and duties as applicable at the time of invoicing. Prices subject to terms above.
                </div>
            </div>
        </div>

        <div class="text-center text-muted small mt-3">
            Generated on @DateTime.Now:dd-MMM-yyyy HH:mm
        </div>
    </div>

    @*@if (!isPdf)
    {
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    }*@
</body>
</html>
