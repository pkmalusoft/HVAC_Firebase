@model HVAC.Models.DashboardViewModel
@{
    ViewBag.Title = "";
    ViewBag.pTitle = "Dashboard";
    ViewBag.pageTitle = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var UserName = "";
    if (Session["UserName"] != null)
    {
        UserName = Session["UserName"].ToString();
    }


}



<div class="row">
    <div class="col-xl-4">
        <div class="card overflow-hidden">
            <div class="bg-primary bg-soft">
                <div class="row">
                    <div class="input-group">
                        <div class="col-md-12">
                            <div class="">

                                <img src="~/assets/images/airmechlogo.png" style="width:100%;height:105px" />


                            </div>
                        </div>

                        @*<div class="col-md-1 text-md-right">
                                <a class="right" title="Click to reprocess" href="JavaScript:void(0)" onclick="DashboardProcess()">
                                    <i class="mdi mdi-refresh" style="font-size: 30px; color: #34c38f; margin-top: 25px;"></i>
                                </a>
                            </div>*@
                    </div>
                </div>
            </div>
            <div class="card-body pt-0">
                <div class="row">
                    <div class="col-sm-4">
                        <div class="avatar-md profile-user-wid mb-4">
                            <img src="~/assets/images/users/avatar-2.jpg" alt="" class="img-thumbnail rounded-circle">
                        </div>
                        <h5 class="font-size-15 text-truncate">Henry Price</h5>
                        <p class="text-muted mb-0 text-truncate">UI/UX Designer</p>
                    </div>

                    <div class="col-sm-8">
                        <div class="pt-4">

                            <div class="row">
                                <div class="col-6">
                                    <h5 class="font-size-15">125</h5>
                                    <p class="text-muted mb-0">Projects</p>
                                </div>
                                <div class="col-6">
                                    <h5 class="font-size-15">$1245</h5>
                                    <p class="text-muted mb-0">Revenue</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <a href="javascript: void(0);" class="btn btn-primary waves-effect waves-light btn-sm">View Profile <i class="mdi mdi-arrow-right ms-1"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-4">Monthly Earning</h4>
                <div class="row">
                    <div class="col-sm-6">
                        <p class="text-muted">This month</p>
                        <h3>$34,252</h3>
                        <p class="text-muted"><span class="text-success me-2"> 12% <i class="mdi mdi-arrow-up"></i> </span> From previous period</p>

                        <div class="mt-4">
                            <a href="javascript: void(0);" class="btn btn-primary waves-effect waves-light btn-sm">View More <i class="mdi mdi-arrow-right ms-1"></i></a>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="mt-4 mt-sm-0">
                            <div id="radialBar-chart" class="apex-charts"></div>
                        </div>
                    </div>
                </div>
                <p class="text-muted mb-0">We craft digital, graphic and dimensional thinking.</p>
            </div>
        </div>
    </div>
    <div class="col-xl-8">
        <div class="row">
            <div class="col-md-4">
                <div class="card mini-stats-wid">
                    <div class="card-body">
                        <div class="d-flex">
                            <input type="hidden" id="hdnCountSeriesA" value="@Model.CountSeriesA" />
                            <input type="hidden" id="hdnCountSeriesB" value="@Model.CountSeriesB" />
                            <input type="hidden" id="hdnCountSeriesC" value="@Model.CountSeriesC" />
                            <input type="hidden" id="hdnCountSeriesD" value="@Model.CountSeriesD" />

                            <input type="hidden" id="hdnRevenueSeriesA" value="@Model.RevenueSeriesA" />
                            <input type="hidden" id="hdnRevenueSeriesB" value="@Model.RevenueSeriesB" />
                            <input type="hidden" id="hdnRevenueSeriesC" value="@Model.RevenueSeriesC" />
                            <input type="hidden" id="hdnRevenueSeriesD" value="@Model.RevenueSeriesD" />
                            <div class="flex-grow-1">
                                <p class="text-muted fw-medium">Enquiries</p>
                                <h4 class="mb-0">@Model.TotalEnquiry</h4>
                            </div>

                            <div class="flex-shrink-0 align-self-center">
                                <div class="mini-stat-icon avatar-sm rounded-circle bg-primary">
                                    <span class="avatar-title">
                                        <i class="bx bx-copy-alt font-size-24"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mini-stats-wid">
                    <div class="card-body">
                        <div class="d-flex">
                            <div class="flex-grow-1">
                                <p class="text-muted fw-medium">Job Value</p>
                                <h4 class="mb-0">@Model.TotalJobvalue</h4>
                            </div>

                            <div class="flex-shrink-0 align-self-center ">
                                <div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
                                    <span class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bx-archive-in font-size-24"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mini-stats-wid">
                    <div class="card-body">
                        <div class="d-flex">
                            <div class="flex-grow-1">
                                <p class="text-muted fw-medium">Average Price</p>
                                <h4 class="mb-0">@Model.TotalJobCost</h4>
                            </div>

                            <div class="flex-shrink-0 align-self-center">
                                <div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
                                    <span class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bx-purchase-tag-alt font-size-24"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- end row -->

        <div class="card">
            <div class="card-body">
                <div id="ChartContainer"></div>

            </div>
        </div>
    </div>
</div>
<!-- end row -->
<!-- end row -->

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-4">Latest Transaction</h4>
                <div class="table-responsive">
                    <table class="table align-middle table-nowrap mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20px;">
                                    <div class="form-check font-size-16 align-middle">
                                        <input class="form-check-input" type="checkbox" id="transactionCheck01">
                                        <label class="form-check-label" for="transactionCheck01"></label>
                                    </div>
                                </th>
                                <th class="align-middle">Enquiry No</th>
                                <th class="align-middle">Client & Project</th>
                                <th class="align-middle">Date</th>

                                <th class="align-middle">Location</th>
                                <th class="align-middle">Assigned To</th>
                                <th class="align-middle">Enquiry Status</th>
                                <th class="align-middle">View Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.RecentOrders)
                            {
                                <tr>
                                    <td>
                                        <div class="form-check font-size-16">
                                            <input class="form-check-input" type="checkbox" id="transactionCheck02">
                                            <label class="form-check-label" for="transactionCheck02"></label>
                                        </div>
                                    </td>
                                    <td><a href="javascript: void(0);" class="text-body fw-bold">@item.EnquiryNo</a> </td>
                                    <td>
                                        <span class="text_over colorblue">@item.ClientName</span>
                                        <span class="text_over colorblue">@item.ProjectName</span>
                                    </td>
                                    <td>
                                        @item.EnquiryDate.ToShortDateString()
                                    </td>

                                    <td>
                                        @item.CityName @item.CountryName
                                    </td>
                                    <td>
                                        @item.AssignedEmps
                                    </td>
                                    <td>
                                        @{
                                            if (item.EnquiryStatus == "Unassigned" || item.EnquiryStatus == "Cancelled" || item.EnquiryStatus == "Regretted")
                                            {
                                                <span class="badge bg-danger">@item.EnquiryStatus</span>
                                            }
                                            else if (item.EnquiryStatus == "Assigned")
                                            {
                                                <span class="badge bg-warning">@item.EnquiryStatus</span>
                                            }
                                            else if (item.EnquiryStatus == "Quoted")
                                            {
                                                <span class="badge bg-primary">@item.EnquiryStatus</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">@item.EnquiryStatus</span>
                                            }

                                        }

                                    </td>
                                    <td>
                                        <!-- Button trigger modal -->
                                        <button type="button" class="btn btn-primary btn-sm btn-rounded waves-effect waves-light" data-bs-toggle="modal" data-bs-target=".transaction-detailModal">
                                            View Details
                                        </button>
                                    </td>
                                </tr>

                            }
                        </tbody>
                    </table>
                </div>
                <!-- end table-responsive -->
            </div>
        </div>
    </div>
</div>
<!-- end row -->
<!-- Modal -->
<div class="modal fade exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Order Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Product id: <span class="text-primary">#SK2540</span></p>
                <p class="mb-4">Billing Name: <span class="text-primary">Neal Matthews</span></p>

                <div class="table-responsive">
                    <table class="table table-centered table-nowrap">
                        <thead>
                            <tr>
                                <th scope="col">Product</th>
                                <th scope="col">Product Name</th>
                                <th scope="col">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">
                                    <div>
                                        <img src="~/assets/images/product/img-7.png" alt="" class="avatar-sm">
                                    </div>
                                </th>
                                <td>
                                    <div>
                                        <h5 class="text-truncate font-size-14">Wireless Headphone (Black)</h5>
                                        <p class="text-muted mb-0">$ 225 x 1</p>
                                    </div>
                                </td>
                                <td>$ 255</td>
                            </tr>
                            <tr>
                                <th scope="row">
                                    <div>
                                        <img src="~/assets/images/product/img-4.png" alt="" class="avatar-sm">
                                    </div>
                                </th>
                                <td>
                                    <div>
                                        <h5 class="text-truncate font-size-14">Phone patterned cases</h5>
                                        <p class="text-muted mb-0">$ 145 x 1</p>
                                    </div>
                                </td>
                                <td>$ 145</td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <h6 class="m-0 text-right">Sub Total:</h6>
                                </td>
                                <td>
                                    $ 400
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <h6 class="m-0 text-right">Shipping:</h6>
                                </td>
                                <td>
                                    Free
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <h6 class="m-0 text-right">Total:</h6>
                                </td>
                                <td>
                                    $ 400
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- end modal -->
<!-- apexcharts -->
@section scripts{

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="~/assets/libs/apexcharts/apexcharts.min.js"></script>

    @*<script src="~/assets/js/pages/dashboard.init.js"></script>*@
    <script src="~/Scripts/JS/Dashboard.js"></script>
    <!-- JAVASCRIPT -->
    <!--<script src="~/assets/libs/jquery/jquery.min.js"></script>
    <script src="~/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/assets/libs/metismenu/metisMenu.min.js"></script>-->


    <script src="~/assets/libs/simplebar/simplebar.min.js"></script>
    <script src="~/assets/libs/node-waves/waves.min.js"></script>
    @*<script src="~/assets/js/lang/jquery.multiLanguage.js"></script>*@

    @*<script src="~/assets/js/app.js"></script>*@

    <script>
        $(document).ready(function () {
            var orderChart;

            function initializeChart() {
                const month = $("#monthDropdown").val();
                const year = $("#yearDropdown").val();

                if (!month || !year) return;

                // Update chart title
                const monthText = $("#monthDropdown option:selected").text();
                $("#chartTitle").text(`Financials by Enquiry Type (${monthText} ${year})`);

                fetch(`/Dashboard/GetHVACChartData?month=${month}&year=${year}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data || data.length === 0) {
                            if (orderChart) orderChart.destroy();
                            $("#orderChart").empty();
                            return;
                        }

                        const categories = data.map(d => d.EnquiryType);
                        const revenue = data.map(d => Number(d.Revenue));
                        const cost = data.map(d => Number(d.Cost));
                        const margin = data.map(d => Number(d.Margin));

                        if (orderChart) orderChart.destroy();

                        orderChart = new ApexCharts(document.querySelector("#orderChart"), {
                            chart: { type: 'bar', height: 400 },
                            series: [
                                { name: 'Revenue', data: revenue },
                                { name: 'Cost', data: cost },
                                { name: 'Margin', data: margin }
                            ],
                            xaxis: { categories: categories },
                            dataLabels: { enabled: true },
                            legend: { position: 'bottom' }
                        });
                        orderChart.render();
                    })
                    .catch(err => console.error("Error fetching chart data:", err));
            }

            function loadProjectAnalysisChart(month, year) {
                $.ajax({
                    type: "POST",
                    url: '/Dashboard/ProjectAnalysisPartial',
                    data: { month: month, year: year },
                    dataType: "html",
                    success: function (html) {
                        $("#ChartContainer").html(html);
                        // Initialize the chart after partial loads
                        initializeChart();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error loading chart partial:", error);
                    }
                });
            }

            // Initial load using current month and year
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            loadProjectAnalysisChart(currentMonth, currentYear);

            // Handle month/year change dynamically
            $(document).on("change", "#monthDropdown, #yearDropdown", function () {
                initializeChart();
            });
        });
    </script>

}

